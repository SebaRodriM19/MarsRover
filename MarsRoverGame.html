<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
    <title>Mars Rover Game</title>
    <style>
        body{
            margin: 15px;
            background-color: black;
        }
        #grid-container{
            padding: 2px;
            margin: 3px;
        }
        .grid-item {
            margin: 5px;
            padding: 7px;
            text-align: center;
            border: 1px dashed #CDBA81;
            border-radius: 5px;
        }

        h1{
            color: gray;
            margin: 5px;
        }

        h2{
            color: grey;
            margin: 5px;
        }

    </style>
</head>
<body>

    <h1>ðŸ›¸ Mars Rover ðŸ›¸</h1>
    <h2>Hi from mars rover in javascript</h2>

    <form id="grid-form" class="row g-2 align-items-center">
        <div class="col">
            <label for="rows-input" class="form-label visually-hidden">Rows</label>
            <input type="number" id="rows-input" class="form-control" required>
        </div>
        <div class="col">
            <label for="columns-input" class="form-label visually-hidden">Columns</label>
            <input type="number" id="columns-input" class="form-control" required>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-success">Start</button>
        </div>
    </form>

      <div id="grid-container" class="row"></div>

    <script>
        const gridContainer = document.getElementById('grid-container');
        const rowsInput = document.getElementById('rows-input');
        const columnsInput = document.getElementById('columns-input');
        const spaceShip = 'ðŸš€';
        const gridItems = [];  // Array for movements

        const game = (event) => {
            event.preventDefault();
            marsRoverGame(parseInt(rowsInput.value),parseInt(columnsInput.value));
        }

        const marsRoverGame = (rows, columns) => {
            gridCreation(rows,columns);
            randomPlaceSpaceship(rows,columns);
        }

        const gridCreation = (rows, columns) => {
            //Remove previous grid
            gridContainer.innerHTML = '';
            gridItems.length = 0;

            //Create cells
            for (let i = 0; i < rows; i++) {
            const row = document.createElement('div');
            row.className = 'row';

            for (let j = 0; j < columns; j++) {
                const gridItem = document.createElement('div');
                gridItem.textContent = "-";
                gridItem.className = 'grid-item col text-white';
                row.appendChild(gridItem);

                gridItems.push(gridItem);  
            }

            gridContainer.appendChild(row);
            }
        }
        
        const randomPlaceSpaceship = (rows, columns) => {
            const randomRow = Math.floor(Math.random() * rows);
            const randomColumn = Math.floor(Math.random() * columns);

            // Select cell
            const row = gridContainer.children[randomRow];
            const cell = row.children[randomColumn];

            cell.textContent = spaceShip;
        }
        const moveSpaceship = (event) => {
            const arrowKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'];

            if (arrowKeys.includes(event.key)) {
                event.preventDefault();

                movementSpaceShip(event.key);
            }
        }
        const movementSpaceShip = (direction) => {
            const foundSpaceShip = findSpaceShip();
            const row = foundSpaceShip.parentNode; // riga che contiene la spaceship
            const rowIndex = Array.from(row.children).indexOf(foundSpaceShip);
            const columnIndex = Array.from(gridContainer.children).indexOf(row);

            let targetCell;

            switch (direction) {
                case 'ArrowUp':
                    // "?" set null a value out of index without generating errors.
                    targetCell = gridContainer.children[columnIndex - 1]?.children[rowIndex]; 
                    if (!targetCell) {
                        targetCell = gridContainer.lastElementChild.children[rowIndex]; //last element col same row
                    }
                    break;
                case 'ArrowDown':
                    targetCell = gridContainer.children[columnIndex + 1]?.children[rowIndex];
                    if (!targetCell) {
                        targetCell = gridContainer.firstElementChild.children[rowIndex]; //first element col same row
                    }
                    break;
                case 'ArrowLeft':
                    targetCell = row.children[rowIndex - 1];
                    if (!targetCell) {
                        targetCell = row.lastElementChild; //last element row same row
                    }
                    break;
                case 'ArrowRight':
                    targetCell = row.children[rowIndex + 1];
                    if (!targetCell) {
                        targetCell = row.firstElementChild; //first element row same row
                    }
                    break;
            }

            if (targetCell && targetCell.textContent !== spaceShip) {
                targetCell.textContent = spaceShip;
                foundSpaceShip.textContent = '-';
                console.log('Movimento spaceship effettuato');
            }
        }


        const findSpaceShip = () => {
            let foundSpaceShip = null; 

            for (const gridItem of gridItems) {
                if (gridItem.textContent === spaceShip) {
                    foundSpaceShip = gridItem;
                    break;
                }
            }
            return foundSpaceShip;    
        }
        document.getElementById('grid-form').addEventListener("submit", game);
        document.addEventListener('keydown', moveSpaceship);
    </script>
</body>
</html>